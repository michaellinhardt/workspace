# Sketchybar Implementation Plan

## Verified Issues

After reviewing the source files, I have verified the following issues from the review:

### Critical - Confirmed

1. **Network Speed Timing Mismatch (VERIFIED)**
   - `network_speed.sh` line 59-60 divides by 2: `SPEED_IN=$(( (BYTES_IN - PREV_IN) / 2 ))`
   - `network_up.sh` and `network_down.sh` both set `update_freq=5`
   - Result: Speed readings are 2.5x higher than actual values

2. **Network Speed Race Condition (VERIFIED)**
   - Both `network_up` and `network_down` items call the same `network_speed.sh` script
   - Both share the same cache file: `/tmp/sketchybar_network/prev_bytes`
   - Result: Second script invocation reads stale data from first, causing incorrect calculations

### Moderate - Confirmed

3. **Misleading Comment Artifacts (VERIFIED)**
   - `items/volume.sh`: Comment says "yellow accent" but uses `$PINK`
   - `items/cpu.sh`: Comment says "magenta accent" but uses `$PINK`
   - `items/wifi.sh`: Comment says "blue accent" but uses `$PINK`
   - `items/ram.sh`: Comment says "orange accent" but uses `$PINK`
   - `items/network_up.sh`: Comment says "green accent" but uses `$PINK`
   - `items/network_down.sh`: Comment says "blue accent" but uses `$PINK`

4. **Hardcoded Battery Icon (VERIFIED)**
   - `items/battery.sh` line 5 uses raw icon character instead of `$BATTERY_100` variable
   - `icons.sh` exports `BATTERY_100=` (line 34)

5. **Duplicate Bracket Definitions (VERIFIED)**
   - `sketchybarrc` has 5 identical bracket arrays (calendar_bracket, audio_bracket, traffic_bracket, resources_bracket, connectivity_bracket)
   - All share exact same properties - could be extracted to a single reusable definition

### Minor - Partially Verified

6. **Ethernet Interface Assumption (NUANCED)**
   - `ethernet.sh` checks `en0` first, assuming it is ethernet
   - However, it then iterates through `en1-en9` as fallback
   - The wifi.sh plugin uses different detection method (not checking ifconfig directly)
   - Impact is minimal as both items show different things (connection type icon)

7. **Unused Color Variables (VERIFIED)**
   - `colors.sh` exports: `BACKGROUND_1`, `BACKGROUND_2`, `WARM_GRAY`, `SHADOW_COLOR`
   - These are not referenced in any item or plugin file reviewed

## Changes Required

### Priority 1 - Bug Fixes (Critical)

**1. Fix network_speed.sh timing calculation**
- Change divisor from 2 to 5 to match `update_freq=5` in network items
- Location: `plugins/network_speed.sh` lines 59-60

**2. Fix network_speed.sh race condition**
- Option A: Use separate cache files for upload/download
- Option B: Calculate both speeds in single invocation and update both items
- Recommended: Option A (simpler, less coupling)

### Priority 2 - Code Quality

**3. Update misleading comments in item files**
- Remove or update color accent references to reflect actual `$PINK` usage

**4. Use icon variable in battery.sh item**
- Replace raw icon character with `$BATTERY_100` variable reference

**5. Extract common bracket style (optional)**
- Define bracket properties once and reuse

## Files to Modify

### Critical Fixes

- `/Users/teazyou/workspace/app.configs/sketchybar/plugins/network_speed.sh`:
  - Line 59: Change `/ 2` to `/ 5`
  - Line 60: Change `/ 2` to `/ 5`
  - Update cache file logic to use separate files per direction

### Code Quality Fixes

- `/Users/teazyou/workspace/app.configs/sketchybar/items/volume.sh`:
  - Line 3: Change "yellow accent" to "pink accent" or remove color reference

- `/Users/teazyou/workspace/app.configs/sketchybar/items/cpu.sh`:
  - Line 3: Change "magenta accent" to "pink accent" or remove color reference

- `/Users/teazyou/workspace/app.configs/sketchybar/items/wifi.sh`:
  - Line 3: Change "blue accent" to "pink accent" or remove color reference

- `/Users/teazyou/workspace/app.configs/sketchybar/items/ram.sh`:
  - Line 3: Change "orange accent" to "pink accent" or remove color reference

- `/Users/teazyou/workspace/app.configs/sketchybar/items/network_up.sh`:
  - Line 3: Change "green accent" to "pink accent" or remove color reference

- `/Users/teazyou/workspace/app.configs/sketchybar/items/network_down.sh`:
  - Line 3: Change "blue accent" to "pink accent" or remove color reference

- `/Users/teazyou/workspace/app.configs/sketchybar/items/battery.sh`:
  - Line 5: Change `icon=` to `icon=$BATTERY_100`

## Risk Assessment

### Low Risk
- Comment updates: No functional impact, purely documentation cleanup
- Battery icon variable: Semantic improvement, icon.sh sources before this executes

### Medium Risk
- **Network speed timing fix**: Users will see ~60% lower speed readings than before (the correct values). This may initially appear as a regression to users accustomed to the inflated numbers.

### Mitigation
- Test network speed readings against actual bandwidth tests (speedtest-cli or fast.com)
- Consider adding a brief comment in network_speed.sh explaining the divisor matches update_freq

## Implementation Order

1. Fix `network_speed.sh` (critical bug)
2. Fix `battery.sh` icon variable (quick win)
3. Update item file comments (batch update)
4. Optional: Extract bracket styles in sketchybarrc (refactor)

---

**Plan created**: 2026-01-08
**Review verified by**: Tech Lead
