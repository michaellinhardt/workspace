# Sketchybar Review

## Summary

This is a well-organized sketchybar configuration following the "CriticalElement" style with a floating bar design and pink/dark theme. The configuration integrates with AeroSpace window manager for workspace management and provides comprehensive system monitoring (CPU, RAM, battery, network, audio, connectivity status).

The architecture follows a clean separation:
- `sketchybarrc`: Main entry point orchestrating item loading and bracket grouping
- `colors.sh` / `icons.sh`: Centralized theming constants
- `items/*.sh`: Item definitions (visual properties, positioning)
- `plugins/*.sh`: Event handlers and data fetchers

**Overall Assessment**: Solid, maintainable configuration with minor issues to address.

---

## Clean Code

### Strengths

1. **Consistent file structure**: Each item file follows the same pattern - define array, add item, subscribe events
2. **Good use of variables**: `$FONT`, `$PLUGIN_DIR`, `$ITEM_DIR` avoid hardcoding
3. **Centralized theming**: Colors and icons are properly exported from dedicated files
4. **Descriptive comments**: Files include clear header comments explaining purpose
5. **Logical grouping**: Items are organized into semantic brackets (audio, traffic, resources, connectivity)

### Issues

1. **Inconsistent comment style in items**: Some comments say "yellow accent", "blue accent", "magenta accent" but all items use `$PINK` - these comments are misleading legacy artifacts
   - `items/volume.sh`: Comment says "yellow accent" but uses `$PINK`
   - `items/cpu.sh`: Comment says "magenta accent" but uses `$PINK`
   - `items/wifi.sh`: Comment says "blue accent" but uses `$PINK`
   - `items/ethernet.sh`: Comment says "blue accent" but uses `$PINK`
   - `items/ram.sh`: Comment says "orange accent" but uses `$PINK`
   - `items/network_up.sh`: Comment says "green accent" but uses `$PINK`
   - `items/network_down.sh`: Comment says "blue accent" but uses `$PINK`

2. **Duplicate bracket definitions**: Four bracket arrays (`calendar_bracket`, `audio_bracket`, `traffic_bracket`, `resources_bracket`, `connectivity_bracket`) in `sketchybarrc` share identical properties. Consider extracting to a reusable function or variable.

3. **Hardcoded icon in battery.sh item**: Line 5 uses a raw icon character instead of `$BATTERY_100` variable:
   ```bash
   icon=  # Should be icon=$BATTERY_100
   ```

4. **Unused variables in colors.sh**: `BACKGROUND_1`, `BACKGROUND_2`, `WARM_GRAY`, `SHADOW_COLOR` are exported but never referenced

5. **Missing shebang consistency**: `time.sh` and `date.sh` have shebangs but are minimal one-liners; this is fine, but other plugins properly source dependencies while these do not source `colors.sh`

---

## Potential Errors

### Critical

1. **network_speed.sh timing mismatch**: The script calculates speed assuming `update_freq=2`:
   ```bash
   SPEED_IN=$(( (BYTES_IN - PREV_IN) / 2 ))
   ```
   But `network_up.sh` and `network_down.sh` both set `update_freq=5`. This causes speed readings to be 2.5x higher than actual values.

2. **Race condition in network_speed.sh**: Both `network_up` and `network_down` items use the same script with the same cache file (`/tmp/sketchybar_network/prev_bytes`). Since they run at the same interval, whichever runs second will read stale data written by the first, resulting in incorrect speed calculations for one direction.

### Moderate

3. **ethernet.sh interface assumption**: The plugin checks `en0` first, assuming it is ethernet. On most MacBooks, `en0` is actually Wi-Fi, not ethernet. The wifi.sh plugin also checks `en0`. This could cause both plugins to show the same interface status.

4. **aerospace.sh MONITOR_INDEX logic**: When workspace is focused, `MONITOR_INDEX` stays 0 but is never used for focused state. When visible but not focused, the logic may not correctly identify monitor position if focused workspace appears after current in the iteration.

### Minor

5. **cpu.sh silent failure**: If `bc` is not installed, the calculation fails silently with potential empty output. While `bc` is typically present on macOS, the fallback `${TOTAL:-0}` handles this gracefully.

6. **headset.sh performance**: `system_profiler SPBluetoothDataType` is relatively slow (can take 1-2 seconds). Running every 5 seconds may cause minor lag. Consider increasing `update_freq` or using a different detection method.

---

## Performance Optimization

### High Impact

1. **Reduce `top` invocation in cpu.sh**: `top -l 1` is expensive (spawns process, samples CPU). Consider caching or using alternative methods like reading `/proc`-style stats if available, or increasing `update_freq` to 10-15 seconds.

2. **Consolidate network_speed.sh calls**: Both network items invoke the same script separately. Refactor to:
   - Have one "master" item that calculates both speeds and updates both items in a single run
   - Or split the cache files and adjust the divisor based on actual timing

3. **aerospace.sh optimization**: The script calls `aerospace list-workspaces` twice (once for visible, once for focused) and `aerospace list-windows` once per workspace. For 9 workspaces, this means up to 11 aerospace commands per workspace change event. Consider:
   - Caching results across workspace items
   - Using a single script that updates all workspace items at once

### Medium Impact

4. **Reduce redundant sourcing**: Several plugins source both `icons.sh` and `colors.sh`. Since `icons.sh` does not depend on `colors.sh`, this is fine, but each source operation reads and parses files. Not significant given current usage, but noted for completeness.

5. **vm_stat parsing in ram.sh**: Runs multiple `grep` and `awk` commands on the same output. Could be optimized with a single `awk` script:
   ```bash
   vm_stat | awk '/Pages (free|active|inactive|speculative|wired|occupied)/ { gsub(/\./,""); sum[$2]+=$3 } END { ... }'
   ```

### Low Impact

6. **Spacer items**: Four spacer items with `width=10` could potentially be consolidated or handled via padding, but current approach is readable and functional.

---

## Recommendations

### Priority 1 - Bug Fixes

1. **Fix network_speed.sh timing**: Change divisor from 2 to 5, or change `update_freq` to 2 in both network items
2. **Fix network_speed.sh race condition**: Use separate cache files (`prev_bytes_up`, `prev_bytes_down`) or update both items from a single script invocation
3. **Fix misleading comments**: Update item file comments to reflect actual color usage

### Priority 2 - Correctness

4. **Fix ethernet.sh interface detection**: Differentiate ethernet from wifi properly; on macOS, consider checking interface type or using `networksetup -listallhardwareports`
5. **Use icon variable in battery.sh item**: Replace raw icon with `$BATTERY_100`

### Priority 3 - Optimization

6. **Batch aerospace.sh updates**: Modify workspace handling to update all 9 items from a single script run
7. **Consider increasing update_freq** for expensive operations (cpu.sh, headset.sh) to 10-15 seconds

### Priority 4 - Code Quality

8. **Extract common bracket style**: Define once and reuse across all bracket configurations
9. **Remove unused color exports**: Clean up `BACKGROUND_1`, `BACKGROUND_2`, `WARM_GRAY`, `SHADOW_COLOR` if truly unused
10. **Document architecture**: Add a brief README explaining the file structure and customization points

---

**Review completed**: 2026-01-08
